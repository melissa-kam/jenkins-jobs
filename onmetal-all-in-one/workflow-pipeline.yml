- job:
    name: OnMetal-All-In-One-Pipeline
    project-type: workflow
    parameters:
        - choice:
            name: REGION
            description: Region of server to build in
            choices:
                - DFW
                - IAD
                - LON
        - choice:
            name: FLAVOR
            descrption: "Note: onmetal-io1 (OnMetal V1) is only avaialble in IAD"
            choices:
                - onmetal-io2
                - onmetal-io1
        - string:
            name: IMAGE
            description: Default is OnMetal - Ubuntu 14.04 LTS (Trusty Tahr)
            default: 9dc2bf0a-7771-45cd-a7f9-ce86ce94c548
        - string:
            name: SERVER_NAME
            description: >
               Optional name of host server. Defaults to Jenkins-OM-AIO-Pipeline-<build number>.
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/rcbops-qe/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
        - string:
            name: JENKINS_OA_REPO
            default: https://github.com/melissa-kam/rax-ansible-testing
        - string:
            name: JENKINS_OA_BRANCH
            default: master
    scm:
        - git:
            url: $JENKINS_OA
            branches:
                - $JENKINS_OA_BRANCH
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
    dsl: |
        node {
            name = SERVER_NAME
            if(name == ""){
                name = "Jenkins-OM-AIO-Pipeline-" + currentBuild.number
            }
            build_parameters = [
                string(name: 'REGION', value: region),
                string(name: 'FLAVOR', value: flavor),
                string(name: 'IMAGE', value: image),
                string(name: 'SERVER_NAME', value: name),
                string(name: 'JENKINS_OA_REPO', value: JENKINS_OA_REPO),
                string(name: 'JENKINS_OA_BRANCH', value: JENKINS_OA_BRANCH),
                string(name: 'OSA_OPS_REPO', value: OSA_OPS_REPO),
                string(name: 'OSA_OPS_BRANCH', value: OSA_OPS_BRANCH)
            ]
            stage('Build OnMetal Host Server') {
                build job: 'OnMetal-AIO-Build-Host', parameters: build_parameters
            }
            stage('Basic Host Server Setup') {
                build job: 'OnMetal-AIO-Setup-Host', parameters: build_parameters
            }
            stage('Setup Cobbler on Host Server') {
                build job: 'OnMetal-AIO-Setup-Cobbler', parameters: build_parameters
            }
            stage('Setup Virtual Networks') {
                build job: 'OnMetal-AIO-Virtual-Networks', parameters: build_parameters
            }
            stage('Deploy VMs') {
                build job: 'OnMetal-AIO-Deploy-VMs', parameters: build_parameters
            }
            stage('Setup for Deploying Openstack Ansible') {
                build job: 'OnMetal-AIO-OpenStack-Setup', parameters: build_parameters
            }
            stage('Deploy RPC') {
            }
        }
