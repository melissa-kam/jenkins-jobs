- job-template:
    name: 'OnMetal-AIO-{deploy-action}'
    build-discarder:
        days-to-keep: 30
    concurrent: true
    parameters:
        - node:
            name: NODE
            description: "OnMetal lab to build in"
            ignore-offline-nodes: true
            allowed-multiselect: true
        - string:
            name: OSA_BRANCH
            default: stable/mitaka
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/rcbops-qe/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
        - string:
            name: OSA_BRANCH
            default: stable/mitaka
        - bool:
            name: PARTITION_HOST
            default: true
    scm:
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
            basedir: openstack-ansible-ops
            wipe-workspace: false
    wrappers:
        - mask-passwords
    builders:
        - install-ansible
        - onmetal-aio-action-builder:
            script: "{script}"

- job-template:
    name: 'OnMetal-AIO-Deploy-RPC'
    build-discarder:
        days-to-keep: 30
    concurrent: true
    parameters:
        - string:
            name: RPC_TAG
            default: r13.0.3
        - node:
            name: NODE
            description: "OnMetal lab to build in"
            ignore-offline-nodes: true
            allowed-multiselect: true
    wrappers:
        - mask-passwords
        - ansicolor:
            colormap: xterm
    builders:
        - onmetal-aio-deploy-rpc

- project:
    name: onmetal-all-in-one-deploy
    deploy-action:
        - Setup-Host:
            script: ./setup-host.sh
        - Setup-Cobbler:
            script: ./setup-cobbler.sh
        - Virtual-Networks:
            script: ./setup-virsh-net.sh
        - Deploy-VMs:
            script: ./deploy-vms.sh
        - OpenStack-Setup:
            script: ./deploy-osa.sh
    jobs:
        - 'OnMetal-AIO-{deploy-action}'
        - 'OnMetal-AIO-Deploy-RPC'

- builder:
    name: onmetal-aio-ansible-action-builder
    description: Runs deployment playbook with specified tags
    builders:
        - shell: |
            #!/bin/bash
            source .venv/bin/activate
            cd rax-ansible-testing

            export ANSIBLE_FORCE_COLOR=true
            export RAX_CREDS_FILE=~/.rackspace_cloud_credentials
            export RAX_REGION=$REGION
            export ANSIBLE_HOST_KEY_CHECKING=False

            ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME osa_branch=$OSA_BRANCH" --skip-tags build --tags {tags}

- builder:
    name: onmetal-aio-setup-script-builder
    description: Runs specified multi-node-aio script
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            export OSA_BRANCH=$OSA_BRANCH
            export PARTITION_HOST=$PARTITION_HOST
            export RUN_OSA=false
            ./{script}

- builder
    name: onmetal-aio-deploy-rpc
    description: Runs all setup and deployment of RPC
    builders:
        - shell: |
            #!/bin/bash -xe
            rm -rf /opt/rpc-openstack

            git clone -b $RPC_TAG --recursive https://github.com/rcbops/rpc-openstack /opt/rpc-openstack
            cd  /opt/rpc-openstack

            cp /etc/openstack_deploy/user_variables.yml /etc/openstack_deploy/user_variables.yml.bak
            cp -R openstack-ansible/etc/openstack_deploy /etc
            cp /etc/openstack_deploy/user_variables.yml.bak /etc/openstack_deploy/user_variables.yml

            mv /etc/openstack_deploy/user_secrets.yml /etc/openstack_deploy/user_osa_secrets.yml
            cp rpcd/etc/openstack_deploy/user_*_defaults.yml /etc/openstack_deploy
            cp rpcd/etc/openstack_deploy/user_rpco_secrets.yml /etc/openstack_deploy
            cp rpcd/etc/openstack_deploy/env.d/* /etc/openstack_deploy/env.d

            export DEPLOY_ELK=no
            export DEPLOY_HARDENING=no
            export DEPLOY_TEMPEST=yes
            export DEFAULT_CONNECTION_PLUGIN_PATH=plugins/connection_plugins
            export DEFAULT_TRANSPORT=ssh_retry

            ./scripts/deploy.sh
