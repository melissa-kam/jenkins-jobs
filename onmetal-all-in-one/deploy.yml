- job-template:
    name: 'OnMetal-AIO-Build-Host'
    description: >
        Creates a public OnMetal server and waits for it to become active.


        OnMetal Production Capacity Dashboard: https://onmetal.ohthree.com/iad-m0002
    build-discarder:
        days-to-keep: 30
    node: 'slaves'
    parameters:
        - choice:
            name: REGION
            description: Region to create server in. Refer to OnMetal capacity dashboard when choosing a region.
            choices:
                - DFW
                - IAD
                - LON
        - choice:
            name: FLAVOR
            descrption: "Note: onmetal-io1 (OnMetal V1) is only avaialble in IAD"
            choices:
                - onmetal-io2
                - onmetal-io1
        - string:
            name: IMAGE
            description: Default is OnMetal - Ubuntu 14.04 LTS (Trusty Tahr)
            default: 9dc2bf0a-7771-45cd-a7f9-ce86ce94c548
        - string:
            name: SERVER_NAME
            description: Optional name for created server. Defaults to Jenkins-OM-AIO-<job build num>.
        - string:
            name: JENKINS_OA_REPO
            default: https://github.com/melissa-kam/rax-ansible-testing
        - string:
            name: JENKINS_OA_BRANCH
            default: master
    scm:
        - jenkins-oa-scm
    wrappers:
        - mask-passwords
        - ansicolor:
            colormap: xterm
    builders:
        - onmetal-aio-build-host-builder

- job-template:
    name: 'OnMetal-AIO-{deploy-action}'
    build-discarder:
        days-to-keep: 30
    node: 'slaves'
    parameters:
        - string:
            name: SERVER_NAME
            default: Jenkins-OM-AIO-
            description: >
               Name of server to run scripts on. Default name for servers created by OnMetal-AIO-Build-Host job
               is Jenkins-OM-AIO-<build number>.
        - choice:
            name: REGION
            description: Region of server to run scripts on
            choices:
                - DFW
                - IAD
                - LON
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/rcbops-qe/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
        - string:
            name: JENKINS_OA_REPO
            default: https://github.com/melissa-kam/rax-ansible-testing
        - string:
            name: JENKINS_OA_BRANCH
            default: master
    scm:
        - jenkins-osa-ops-scm
    wrappers:
        - mask-passwords
        - ansicolor:
            colormap: xterm
    builders:
        - install-ansible
        - onmetal-aio-action-builder:
            tags: "{tags}"

- project:
    name: onmetal-all-in-one-deploy
    deploy-action:
        - Setup-Host:
            tags: host
        - Setup-Cobbler:
            tags: cobbler
        - Virtual-Networks:
            tags: networks
        - Deploy-VMs:
            tags: vms
        - OpenStack-Setup:
            tags: osa
    jobs:
        - 'OnMetal-AIO-Build-Host'
        - 'OnMetal-AIO-{deploy-action}'

- scm:
    name: jenkins-oa-scm
    scm:
        - git:
            url: $JENKINS_OA_REPO
            branches:
                - $JENKINS_OA_BRANCH
            basedir: rax-ansible-testing
            wipe-workspace: false
- scm:
    name: osa-ops-scm
    scm:
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
            basedir: openstack-ansible-ops
            wipe-workspace: false
- scm:
    name: jenkins-osa-ops-scm
    scm:
        - jenkins-oa-scm
        - osa-ops-scm

- builder:
    name: install-ansible
    builders:
        - shell: |
            #!/bin/bash
            if [[ ! -d ".venv" ]]; then
                virtualenv .venv
            fi
            source .venv/bin/activate
            pip install ansible pyrax

- builder:
    name: onmetal-aio-build-host-builder
    description: Creates an OnMetal cloud server.
    builders:
        - shell: |
            #!/bin/bash
            source .venv/bin/activate

            export ANSIBLE_FORCE_COLOR=true
            export RAX_CREDS_FILE=~/.rackspace_cloud_credentials
            export RAX_REGION=$REGION
            export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}

            ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME flavor=$FLAVOR image=$IMAGE count=1 key_name=jenkins group=om-aio" --tags build --skip-tags always

- builder:
    name: onmetal-aio-action-builder
    description: Runs all required host setup
    builders:
        - shell: |
            #!/bin/bash
            source .venv/bin/activate
            cd rax-ansible-testing

            export ANSIBLE_FORCE_COLOR=true
            export RAX_CREDS_FILE=~/.rackspace_cloud_credentials
            export RAX_REGION=$REGION
            export SERVER_NAME=${{SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}}
            export ANSIBLE_HOST_KEY_CHECKING=False

            ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME" --skip-tags build --tags {tags}
