- job-template:
    name: 'OnMetal-AIO-Build-Host'
    description: >
        Creates a public OnMetal server and waits for it to become active.


        OnMetal Production Capacity Dashboard: https://onmetal.ohthree.com/iad-m0002
    logrotate:
        daysToKeep: 30
    parameters:
        - choice:
            name: REGION
            description: Region to create server in. Refer to OnMetal capacity dashboard when choosing a region.
            choices:
                - DFW
                - IAD
                - LON
        - choice:
            name: FLAVOR
            descrption: "Note: onmetal-io1 (OnMetal V1) is only avaialble in IAD"
            choices:
                - onmetal-io2
                - onmetal-io1
        - string:
            name: IMAGE
            description: Default is OnMetal - Ubuntu 14.04 LTS (Trusty Tahr)
            default: 9dc2bf0a-7771-45cd-a7f9-ce86ce94c548
        - string:
            name: SERVER_NAME
            description: Optional name for created server. Defaults to Jenkins-OM-AIO-<job build num>.
        - string:
            name: JENKINS_OA_REPO
            default: https://github.com/melissa-kam/rax-ansible-testing
        - string:
            name: JENKINS_OA_BRANCH
            default: master
    scm:
        - git:
            url: $JENKINS_OA_REPO
            branches:
                - $JENKINS_OA_BRANCH
    wrappers:
      - mask-passwords
      - ansicolor:
            colormap: xterm
    builders:
        - OnMetal-Build-Host

- job-template:
    name: 'OnMetal-AIO-{deploy-action}'
    logrotate:
        daysToKeep: 30
    parameters:
        - string:
            name: SERVER_NAME
            default: Jenkins-OM-AIO-
            description: >
               Name of server to run scripts on. Default name for servers created by OnMetal-AIO-Build-Host job
               is Jenkins-OM-AIO-<build number>.
        - choice:
            name: REGION
            description: Region of server to run scripts on
            choices:
                - DFW
                - IAD
                - LON
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/rcbops-qe/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
        - string:
            name: JENKINS_OA_REPO
            default: https://github.com/melissa-kam/rax-ansible-testing
        - string:
            name: JENKINS_OA_BRANCH
            default: master
    scm:
        - git:
            url: $JENKINS_OA_REPO
            branches:
                - $JENKINS_OA_BRANCH
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
    wrappers:
      - mask-passwords
      - ansicolor:
            colormap: xterm
    builders:
        - OnMetal-{deploy-action}


- project:
    name: onmetal-all-in-one-deploy
    deploy-action:
        - Setup-Host
        - Setup-Cobbler
        - Virtual-Networks
        - Deploy-VMs
        - OpenStack-Setup
    jobs:
        - 'OnMetal-AIO-Build-Host'
        - 'OnMetal-AIO-{deploy-action}'


- builder:
    name: OnMetal-Build-Host
    description: Creates an OnMetal cloud server.
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            nature: shell
            command: |
                #!/bin/bash
                cd rax-ansible-testing
                pip install ansible pyrax
                export ANSIBLE_FORCE_COLOR=true
                export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}

                ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME region=$REGION flavor=$FLAVOR image=$IMAGE count=1 key_name=jenkins-key group=om-aio" --tags build --skip-tags always

- builder:
    name: OnMetal-Setup-Host
    description: Runs all required host setup
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            nature: shell
            command: |
                #!/bin/bash
                cd rax-ansible-testing
                pip install ansible pyrax
                export ANSIBLE_FORCE_COLOR=true
                export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}
                export ANSIBLE_HOST_KEY_CHECKING=False

                ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME region=$REGION" --skip-tags build --tags setup

- builder:
    name: OnMetal-Setup-Cobbler
    description: Runs installation and configuration of Cobbler
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            nature: shell
            command: |
                #!/bin/bash
                cd rax-ansible-testing
                pip install ansible pyrax
                export ANSIBLE_FORCE_COLOR=true
                export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}
                export ANSIBLE_HOST_KEY_CHECKING=False

                ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME region=$REGION" --skip-tags build --tags cobbler

- builder:
    name: OnMetal-Virtual-Networks
    description: Setup libvirt networks used for the Host VMs
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            nature: shell
            command: |
                #!/bin/bash
                cd rax-ansible-testing
                pip install ansible pyrax
                export ANSIBLE_FORCE_COLOR=true
                export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}
                export ANSIBLE_HOST_KEY_CHECKING=False

                ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME region=$REGION" --skip-tags build --tags networks

- builder:
    name: OnMetal-Deploy-VMs
    description:
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            nature: shell
            command: |
                #!/bin/bash
                cd rax-ansible-testing
                pip install ansible pyrax
                export ANSIBLE_FORCE_COLOR=true
                export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}
                export ANSIBLE_HOST_KEY_CHECKING=False

                ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME region=$REGION" --skip-tags build --tags vms
- builder:
    name: OnMetal-OpenStack-Setup
    description:
    builders:
        - shining-panda:
            build-environment: virtualenv
            python-version: System-CPython-2.7
            nature: shell
            command: |
                #!/bin/bash
                cd rax-ansible-testing
                pip install ansible pyrax
                export ANSIBLE_FORCE_COLOR=true
                export SERVER_NAME=${SERVER_NAME:-"Jenkins-OM-AIO-$BUILD_NUMBER"}
                export ANSIBLE_HOST_KEY_CHECKING=False

                ansible-playbook public-cloud-deploy.yml -i inventory/ --extra-vars "name=$SERVER_NAME region=$REGION" --skip-tags build --tags osa
