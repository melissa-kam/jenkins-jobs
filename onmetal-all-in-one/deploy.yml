- job-template:
    name: 'OnMetal-AIO-Build-Host'
    description: >
        Creates a public OnMetal server and waits for it to become active.


        OnMetal Production Capacity Dashboard: https://onmetal.ohthree.com/iad-m0002
    logrotate:
        daysToKeep: 30
    parameters:
        - choice:
            name: REGION
            choices:
                - IAD
                - DFW
                - LON
        - choice:
            name: FLAVOR
            choices:
                - onmetal-io2
                - onmetal-io1
        - string:
            name: IMAGE
            description: Default is OnMetal - Ubuntu 14.04 LTS (Trusty Tahr)
            default: 9dc2bf0a-7771-45cd-a7f9-ce86ce94c548
        - string:
            name: SERVER_NAME
            description: Optional name for created server.
            default:
    scm:
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
    wrappers:
      - mask-passwords
      - ansicolor:
            colormap: xterm
    builders:
        - OnMetal-Build-Host

- job-template:
    name: 'OnMetal-AIO-{deploy-action}'
    logrotate:
        daysToKeep: 30
    parameters:
        - string:
            name: OSA_OPS_REPO
            default: https://github.com/rcbops-qe/openstack-ansible-ops
        - string:
            name: OSA_OPS_BRANCH
            default: master
    scm:
        - git:
            url: $OSA_OPS_REPO
            branches:
                - $OSA_OPS_BRANCH
    wrappers:
      - mask-passwords
      - ansicolor:
            colormap: xterm
    builders:
        - OnMetal-{deploy-action}


- project:
    name: onmetal-all-in-one-deploy
    deploy-action:
        - Setup-Host
        - Setup-Cobbler
        - Setup-Virsh
        - Deploy-VMs
        - Deploy-OpenStack
    jobs:
        - 'OnMetal-AIO-Build-Host'
        - 'OnMetal-AIO-{deploy-action}'


- builder:
    name: OnMetal-Build-Host
    description: Creates an OnMetal cloud server.
    builders:
        - shell: |
            #!/bin/bash

- builder:
    name: OnMetal-Setup-Host
    description: Runs all required host setup
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            source setup-host.sh

- builder:
    name: OnMetal-Setup-Cobbler
    description: Runs installation and configuration of Cobbler
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            source setup-cobbler.sh


- builder:
    name: OnMetal-Setup-Virsh
    description: Setup libvirt networks used for the Host VMs
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            source setup-virsh-net.sh

- builder:
    name: OnMetal-Deploy-VMs
    description:
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            source deploy-vms.sh

- builder:
    name: OnMetal-Deploy-OpenStack
    description:
    builders:
        - shell: |
            #!/bin/bash
            cd multi-node-aio
            source deploy-osa.sh
